let s=null,c=null,p='white',g=!1,S=null,i=null,r=1200,u='',a=!1,d='medium',O=null,H=[],C='match';const P={w:{k:'♔',q:'♕',r:'♖',b:'♗',n:'♘',p:'♙'},b:{k:'♚',q:'♛',r:'♜',b:'♝',n:'♞',p:'♟'}};const b={beginner:800,easy:1000,medium:1200,hard:1600,expert:2000};const v=window.location.hostname==='localhost'?'http://localhost:3000':'https://theamazinggame.onrender.com';document.addEventListener('DOMContentLoaded',function(){if(typeof Chess==='undefined'){console.error('Chess.js not loaded');setTimeout(function(){location.reload()},2000);return;}const t=getModdIOUsername();console.log('Detected username:',t);const e=document.getElementById('username-input');if(e&&t){e.value=t;}connectSocket();setTimeout(function(){if(t){login(t);}},1000);});function getModdIOUsername(){try{if(window.frameElement&&window.frameElement.id){const t=window.frameElement.id.split('-');if(t.length>=4&&t[0]==='conqframe'&&t[1]==='llkasz'){if(t[2]==='lurbs'){a=!0;return'lurbs';}else{a=!1;return t[2];}}if(t.length>=4&&t[0]==='conqframe'&&t[1]==='jkasz'){a=!1;return t[2];}}}catch(e){}const l=document.querySelectorAll('[id^="llkasz-"]');for(let t=0;t<l.length;t++){const e=l[t].id.split('-');if(e.length>=3){if(e[1]==='lurbs'){a=!0;return'lurbs';}a=!1;return e[1];}}const n=document.querySelectorAll('[id^="jkasz-"]');for(let t=0;t<n.length;t++){const e=n[t].id.split('-');if(e.length>=3){a=!1;return e[1];}}a=!1;return'guest-'+Math.floor(Math.random()*9900+100);}function connectSocket(){s=io(v,{transports:['websocket','polling'],reconnection:!0,reconnectionAttempts:5});s.on('connect',function(){console.log('Socket connected successfully');});s.on('disconnect',function(){console.log('Socket disconnected');});setupSocketHandlers();}function setupSocketHandlers(){s.on('loginSuccess',function(t){handleLoginSuccess(t);});s.on('loginError',function(t){alert('Login failed: '+t);});s.on('gameStart',function(t){handleGameStart(t);});s.on('moveMade',function(t){handleMoveMade(t);});s.on('gameEnd',function(t){console.log('Received gameEnd:',t);handleGameEnd(t);});s.on('timeUpdate',function(t){updateTimeDisplay(t.timeWhite,t.timeBlack);});s.on('chatMessage',function(t){addChatMessage(t.username,t.message,t.isGlobal);});s.on('queueJoined',function(t){document.getElementById('queue-overlay').style.display='flex';updateEstimatedWait(t);});s.on('queueLeft',function(){document.getElementById('queue-overlay').style.display='none';});s.on('playerProfile',function(t){showPlayerProfile(t);});s.on('analysisReady',function(t){displayAnalysis(t.analysis);});s.on('drawOffered',function(){if(confirm('Your opponent has offered a draw. Do you accept?')){s.emit('acceptDraw');}else{s.emit('declineDraw');}});s.on('drawDeclined',function(){alert('Your draw offer was declined.');});s.on('playerList',function(t){updatePlayerList(t.players);});s.on('kicked',function(t){alert('You have been kicked: '+t.reason);location.reload();});s.on('banned',function(t){alert('You have been banned: '+t.reason);location.reload();});s.on('invalidMove',function(t){console.log('Invalid move received:',t);alert('Invalid move: '+(t.error||'Unknown error'));});}function login(t){const e=t||document.getElementById('username-input').value.trim();if(e.length<2){alert('Username must be at least 2 characters');return;}s.emit('login',{username:e,isAdmin:a});}function handleLoginSuccess(t){u=t.username;r=t.rating;document.getElementById('user-name').textContent=t.username;document.getElementById('user-rating').textContent=t.rating;document.getElementById('stat-games').textContent=t.stats.gamesPlayed;document.getElementById('stat-wins').textContent=t.stats.wins;document.getElementById('stat-winrate').textContent=t.stats.winRate+'%';document.getElementById('stat-rating').textContent=t.rating;document.getElementById('login-screen').style.display='none';document.getElementById('app').style.display='block';if(t.isAdmin){showAdminPanel();}loadLeaderboard();}function handleGameStart(t){i=t.gameId;p=t.color;g=!0;O=p==='white'?t.black:t.white;try{c=new Chess(t.fen);}catch(e){c=new Chess();}document.getElementById('home-view').style.display='none';document.getElementById('game-view').style.display='flex';const e=p==='white';document.getElementById('player-name').textContent=e?t.white.username:t.black.username;document.getElementById('player-rating-display').textContent=e?t.white.rating:t.black.rating;document.getElementById('opponent-name').textContent=e?t.black.username:t.white.username;document.getElementById('opponent-rating').textContent=e?t.black.rating:t.white.rating;const n=document.getElementById('opponent-name');n.style.cursor='pointer';n.onclick=function(){viewPlayerProfile(O.username);};updateTimeDisplay(t.timeControl.initial,t.timeControl.initial);renderBoard();document.getElementById('move-list').innerHTML='';document.getElementById('queue-overlay').style.display='none';updateActivePlayer();}function handleMoveMade(t){if(!g||!c)return;console.log('Received move:',t);try{c.load(t.fen);}catch(e){console.error('Failed to load FEN:',e);return;}addMoveToHistory(t.san);updateTimeDisplay(t.timeWhite,t.timeBlack);renderBoard();updateActivePlayer();}function handleGameEnd(t){g=!1;const e=document.getElementById('game-end-modal'),n=document.getElementById('modal-result'),o=document.getElementById('modal-reason');if(t.result==='draw'){n.textContent='Draw!';n.className='modal-result draw';}else if((t.result==='white'&&p==='white')||(t.result==='black'&&p==='black')){n.textContent='Victory!';n.className='modal-result win';}else{n.textContent='Defeat';n.className='modal-result loss';}const a={'checkmate':'by checkmate','stalemate':'by stalemate','draw':'by agreement','resignation':'by resignation','timeout':'by timeout','aborted':'game aborted'};o.textContent=a[t.reason]||t.reason;e.style.display='flex';if(i){setTimeout(function(){s.emit('requestAnalysis',i);},1000);}}function updateEstimatedWait(t){const e=t.queueSize||1,n=Math.max(5,e*15);document.querySelector('.queue-status').textContent='Queue size: '+e+' players • Est. wait: '+n+'s';}function showView(t){if(g&&t!=='game'){if(confirm('You are in the middle of a game. Are you sure you want to leave?')){if(confirm('Would you like to resign the current game?')){s.emit('resign');}g=!1;}else{return;}}document.getElementById('home-view').style.display='none';document.getElementById('game-view').style.display='none';document.getElementById('leaderboard-view').style.display='none';document.getElementById('profile-view').style.display='none';var e=document.getElementById('admin-view');if(e)e.style.display='none';if(t==='home'){document.getElementById('home-view').style.display='block';}else if(t==='game'){document.getElementById('game-view').style.display='flex';}else if(t==='leaderboard'){document.getElementById('leaderboard-view').style.display='block';loadLeaderboard();}else if(t==='profile'){document.getElementById('profile-view').style.display='block';loadProfile();}else if(t==='admin'){if(e)e.style.display='block';loadAdminPanel();}}function joinQueue(t){s.emit('joinQueue',{type:t,timeControl:'rapid'});}function leaveQueue(){s.emit('leaveQueue');}function selectBot(t){d=t;var e=document.querySelectorAll('.bot-btn');for(var n=0;n<e.length;n++){e[n].classList.remove('selected');}if(event&&event.target){event.target.closest('.bot-btn').classList.add('selected');}}function playBot(){s.emit('playBot',{difficulty:d,timeControl:'rapid',color:'random'});}function renderBoard(){var t=document.getElementById('chess-board');if(!t||!c)return;var e;try{e=c.board();}catch(n){return;}var o='';for(var a=0;a<8;a++){o+='<div class="board-row">';for(var d=0;d<8;d++){var H=e[a][d],P=(a+d)%2===0,m=String.fromCharCode(97+d)+(8-a),I=['square',P?'light':'dark'];if(S===m){I.push('selected');}var C=c.history({verbose:!0});if(C.length>0){var T=C[C.length-1];if(T.from===m||T.to===m){I.push('last-move');}}if(S){try{var h=c.moves({square:S,verbose:!0});for(var p=0;p<h.length;p++){if(h[p].to===m){if(H){I.push('valid-capture');}else{I.push('valid-move');}break;}}}catch(l){}}o+='<div class="'+I.join(' ')+'" data-square="'+m+'" onclick="onSquareClick(\''+m+'\')">';if(H){var L=P[H.color][H.type];o+='<span class="chess-piece">'+L+'</span>';}if(d===0){o+='<span class="coord rank">'+(8-a)+'</span>';}if(a===7){o+='<span class="coord file">'+String.fromCharCode(97+d)+'</span>';}o+='</div>';}o+='</div>';}t.innerHTML=o;}function analyzeGame(){if(!i){alert('No game to analyze');return;}s.emit('requestAnalysis',{gameId:i});s.once('analysisReady',function(t){showAnalysisModal(t.analysis);});s.once('analysisError',function(t){alert('Analysis failed: '+t);});}function showAnalysisModal(t){let e=document.getElementById('analysis-modal');if(!e){e=document.createElement('div');e.id='analysis-modal';e.className='modal';e.innerHTML='<div class="modal-content"><h2>Game Analysis</h2><div id="analysis-content"></div><button class="modal-btn primary" onclick="closeAnalysisModal()">Close</button></div>';document.body.appendChild(e);}let n=document.getElementById('analysis-content');if(!n){n=document.createElement('div');n.id='analysis-content';e.querySelector('.modal-content').appendChild(n);}let o='<div class="analysis-summary">';o+='<h3>Accuracy: '+(t.accuracy||'N/A')+'%</h3>';o+='<p>Best Move: '+(t.bestMoveCount||0)+'</p>';o+='<p>Excellent Moves: '+(t.excellentCount||0)+'</p>';o+='<p>Good Moves: '+(t.goodCount||0)+'</p>';o+='<p>Inaccuracies: '+(t.inaccuracies||0)+'</p>';o+='<p>Mistakes: '+(t.mistakes||0)+'</p>';o+='<p>Blunders: '+(t.blunders||0)+'</p>';o+='</div>';o+='<div class="move-analysis">';o+='<h3>Move by Move Analysis</h3>';o+='<table>';o+='<tr><th>Move</th><th>Move</th><th>Classification</th><th>Evaluation</th></tr>';(t.movesWithEval||[]).forEach(function(e){o+='<tr>';o+='<td>'+e.moveNumber+'</td>';o+='<td>'+e.san+'</td>';o+='<td class="classification-'+e.classification+'">'+e.classification+'</td>';o+='<td>'+e.eval+'</td>';o+='</tr>';});o+='</table>';o+='</div>';n.innerHTML=o;e.style.display='flex';}function closeAnalysisModal(){const t=document.getElementById('analysis-modal');if(t){t.style.display='none';}}function onSquareClick(t){if(!g||!c){console.log('Game not active or chess not initialized');return;}console.log('Square clicked:',t,'Player color:',p,'Chess turn:',c.turn());console.log('Socket connected:',s&&s.connected);if(c.turn()!==(p==='white'?'w':'b')){console.log('Not player\'s turn');return;}if(S){console.log('Moving from',S,'to',t);try{var e=c.moves({square:S,verbose:!0});console.log('Available moves from',S,':',e);var n=null;for(var o=0;o<e.length;o++){if(e[o].to===t){n=e[o];break;}}if(n){console.log('Valid move found:',n);if(n.promotion){showPromotionModal(S,t);return;}console.log('Sending move:',{from:S,to:t,promotion:n.promotion?'q':undefined});if(s&&s.connected){s.emit('makeMove',{from:S,to:t,promotion:n.promotion?'q':undefined});console.log('Move sent successfully');}else{console.log('Socket not connected, cannot send move');}S=null;}else{console.log('Invalid move target');var a=c.get(t);if(a&&a.color===(p==='white'?'w':'b')){S=t;}else{S=null;}}}catch(d){console.error('Error processing move:',d);S=null;}}else{console.log('Selecting square:',t);try{var H=c.get(t);console.log('Piece at',t,':',H);if(H&&H.color===(p==='white'?'w':'b')){S=t;console.log('Selected square:',S);}}catch(P){console.error('Error selecting square:',P);}}renderBoard();}var k=null;function showPromotionModal(t,e){k={from:t,to:e};document.getElementById('promotion-modal').style.display='flex';}function promote(t){document.getElementById('promotion-modal').style.display='none';if(!k)return;s.emit('makeMove',{from:k.from,to:k.to,promotion:t});k=null;S=null;}function updateActivePlayer(){if(!c)return;var t=c.turn()==='w',e=document.getElementById('player-top'),n=document.getElementById('player-bottom');if(p==='white'){if(e)e.classList.toggle('active',!t);if(n)n.classList.toggle('active',t);}else{if(e)e.classList.toggle('active',t);if(n)n.classList.toggle('active',!t);}}function updateTimeDisplay(t,e){var n=document.getElementById('player-time'),o=document.getElementById('opponent-time');if(!n||!o)return;var a=p==='white',d=a?t:e,H=a?e:t;n.textContent=formatTime(d);o.textContent=formatTime(H);n.classList.toggle('low',d<60);o.classList.toggle('low',H<60);}function formatTime(t){if(t===undefined||t===null)return'--:--';var e=Math.floor(t/60),n=Math.floor(t%60);return e+':'+n.toString().padStart(2,'0');}function addMoveToHistory(t){var e=document.getElementById('move-list');if(!e||!t)return;var n=c&&c.history?c.history().length:0,o=Math.ceil(n/2),a=n%2===1;if(a){var d=document.createElement('div');d.className='move-number';d.textContent=o+'.';e.appendChild(d);var H=document.createElement('div');H.className='move-white';H.textContent=t;e.appendChild(H);var P=document.createElement('div');P.className='move-black';e.appendChild(P);}else{var m=e.querySelectorAll('.move-black');if(m.length>0){m[m.length-1].textContent=t;}}var I=document.getElementById('move-history');if(I){I.scrollTop=I.scrollHeight;}}function switchChat(t){C=t;var e=document.querySelectorAll('.chat-tab');for(var n=0;n<e.length;n++){e[n].classList.remove('active');}if(event&&event.target){event.target.classList.add('active');}}function sendChatMessage(){var t=document.getElementById('chat-input');if(!t)return;var e=t.value.trim();if(!e)return;sendChat(e,C==='global');t.value='';}function sendLobbyChatMessage(){var t=document.getElementById('lobby-chat-input');if(!t)return;var e=t.value.trim();if(!e)return;sendChat(e,!0);t.value='';}function sendChat(t,e){if(!s)return;s.emit('sendChat',{message:t,isGlobal:e,gameId:e?null:i});}function addChatMessage(t,e,n){H.push({username:t,message:e,isGlobal:n});updateChatDisplay();if(n){addLobbyChatMessage(t,e);}}function updateChatDisplay(){var t=document.getElementById('chat-messages');if(!t)return;var e='';for(var n=0;n<H.length;n++){var o=H[n];e+='<div class="chat-message '+(o.isGlobal?'global':'match')+'">';e+='<span class="chat-username">'+escapeHtml(o.username)+':</span>';e+='<span class="chat-text">'+escapeHtml(o.message)+'</span>';e+='</div>';}t.innerHTML=e;t.scrollTop=t.scrollHeight;}function handleLobbyChatMessage(t){if(t.isGlobal){addLobbyChatMessage(t.username,t.message);}}function addLobbyChatMessage(t,e){var n=document.getElementById('lobby-chat-messages');if(!n)return;var o=document.createElement('div');o.className='chat-message global';o.innerHTML='<span class="chat-username">'+escapeHtml(t)+':</span>'+'<span class="chat-text">'+escapeHtml(e)+'</span>';n.appendChild(o);n.scrollTop=n.scrollHeight;}function escapeHtml(t){var e=document.createElement('div');e.textContent=t;return e.innerHTML;}function offerDraw(){s.emit('offerDraw');}function resign(){if(confirm('Are you sure you want to resign?')){s.emit('resign');}}function newGame(){document.getElementById('game-end-modal').style.display='none';showView('home');}function showAdminPanel(){var t=document.getElementById('admin-view');if(!t){t=document.createElement('div');t.id='admin-view';t.style.display='none';t.innerHTML='<div class="card"><h2>Admin Panel</h2><div id="admin-player-list"></div></div>';document.querySelector('.main-content').appendChild(t);var e=document.querySelector('.nav');if(e){var n=document.createElement('button');n.className='nav-btn';n.textContent='Admin';n.onclick=function(){showView('admin');};e.appendChild(n);}}s.emit('getPlayerList');}function loadAdminPanel(){s.emit('getPlayerList');}function updatePlayerList(t){var e=document.getElementById('admin-player-list');if(!e)return;var n='<table class="leaderboard-table"><thead><tr><th>User</th><th>Rating</th><th>Status</th></tr></thead><tbody>';for(var o=0;o<t.length;o++){var a=t[o];n+='<tr><td>'+a.username+'</td><td>'+a.rating+'</td><td>'+(a.isBanned?'Banned':a.isMuted?'Muted':'Active')+'</td></tr>';}n+='</tbody></table>';e.innerHTML=n;}function viewPlayerProfile(t){s.emit('getPlayerProfile',t);}function showPlayerProfile(t){alert('Player: '+t.username+'\nRating: '+t.rating+'\nGames: '+t.gamesPlayed);}function displayAnalysis(t){var e=document.getElementById('game-analysis');if(!e||!t)return;e.innerHTML='<div>Accuracy: White '+(t.accuracy.white||0).toFixed(1)+'% - Black '+(t.accuracy.black||0).toFixed(1)+'%</div>';}function loadLeaderboard(){fetch(v+'/api/leaderboard').then(function(t){return t.json();}).then(function(t){var e=document.getElementById('leaderboard-body');if(!e)return;var n='';for(var o=0;o<t.length&&o<50;o++){var a=t[o];n+='<tr><td>'+(o+1)+'</td><td>'+a.username+'</td><td>'+a.rating+'</td><td>'+(a.wins||0)+'</td><td>'+(a.gamesPlayed||0)+'</td></tr>';}e.innerHTML=n||'<tr><td colspan="6">No players</td></tr>';}).catch(function(t){console.error('Leaderboard error:',t);});}function loadProfile(){var t=getModdIOUsername();if(t.startsWith('guest-')){document.getElementById('profile-content').innerHTML='<p style="text-align: center; color: #888;">Guest users don\'t have profiles.</p>';return;}fetch(v+'/api/player/'+u).then(function(t){return t.json();}).then(function(t){var e=document.getElementById('profile-content');if(!e)return;e.innerHTML='<div style="text-align: center;"><h2>'+t.username+'</h2><div style="font-size: 2rem; color: #00d4ff;">'+t.rating+'</div></div>';}).catch(function(t){console.error('Profile error:',t);});}